name: Olympix Mutation Testing

# - runs the olympix mutation testing on chain-facing solidity contracts inside the src/ folder
# - evaluates test suite quality by introducing code mutations and checking if tests catch them
# - always scans relevant solidity files in src/ to maintain consistent GitHub Code Scanning state
# - uploads mutation testing results to github code scanning for review and discussion within the PR

# Configuration: Directories to exclude from mutation testing
# These typically contain interfaces, utility code, tests, or mocks that aren't chain-facing
env:
  EXCLUDED_DIRS: "Interfaces Libraries Helpers Errors"  # Space-separated list of directory names to ignore

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    paths:
      - 'src/**/*.sol'
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  checks: write

jobs:
  mutation-testing:
    name: Check for Solidity Files
    runs-on: ubuntu-latest
    outputs:
      SHOULD_RUN: ${{ steps.check-files.outputs.SHOULD_RUN }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Check for Solidity Files
        id: check-files
        run: |
          # Configuration: Define excluded directories
          echo "üîç Excluded directories: ${EXCLUDED_DIRS}"
          
          # Build find command with exclusions
          FIND_CMD="find src/ -name '*.sol' -type f"
          
          # Add exclusions for each directory (manually handle known directories)
          for dir in Interfaces Libraries Helpers Errors; do
            FIND_CMD="$FIND_CMD ! -path 'src/$dir/*'"
            echo "üö´ Excluding: src/$dir/*"
          done
          
          echo "üìã Find command: $FIND_CMD"
          
          # Execute the find command
          files=$(eval "$FIND_CMD" 2>/dev/null || true)
          
          if [[ -n "$files" && $(echo "$files" | wc -w) -gt 0 ]]; then
            echo "SHOULD_RUN=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Found $(echo "$files" | wc -w) chain-facing Solidity files to analyze"
            
            # Show what we're including
            echo "üìÅ Chain-facing files found:"
            echo "$files" | head -10
            if [[ $(echo "$files" | wc -l) -gt 10 ]]; then
              echo "... and $(($(echo "$files" | wc -l) - 10)) more files"
            fi
          else
            echo "SHOULD_RUN=false" >> $GITHUB_OUTPUT
            echo "‚ùå No chain-facing Solidity files found in src/"
          fi

  # Process chain-facing files only
  mutation-testing-execution:
    name: Mutation Testing
    runs-on: ubuntu-latest
    needs: mutation-testing
    if: needs.mutation-testing.outputs.SHOULD_RUN == 'true'
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Generate File Arguments
        id: file-args
        run: |
          # Configuration: Define excluded directories
          echo "üîç Building file list with exclusions: ${EXCLUDED_DIRS}"
          
          # Build find command with exclusions
          FIND_CMD="find src/ -name '*.sol' -type f"
          
          # Add exclusions for each directory (manually handle known directories)
          for dir in Interfaces Libraries Helpers Errors; do
            FIND_CMD="$FIND_CMD ! -path 'src/$dir/*'"
          done
          
          # Get chain-facing Solidity files (limit to 100 for CLI compatibility)
          files=$(eval "$FIND_CMD" | head -100)
          total_files=$(echo "$files" | wc -l)
          
          echo "üîÑ Running mutation testing on chain-facing Solidity files"
          echo "üìÅ Found $total_files chain-facing files to analyze (limited to first 100)"
          
          # Show excluded vs included breakdown
          all_files=$(find src/ -name "*.sol" -type f | wc -l)
          excluded_files=$(eval "$FIND_CMD" | wc -l)
          excluded_count=$((all_files - excluded_files))
          echo "üìä File breakdown: $total_files included, $excluded_count excluded (total: $all_files)"
          
          # Generate CLI arguments with explicit file paths
          args="-w . -env"
          for file in $files; do
            args="$args -p $file"
          done
          
          echo "MUTATION_ARGS=$args" >> $GITHUB_OUTPUT
          echo "üöÄ Generated arguments for chain-facing files only"

      - name: Run Olympix Mutation Testing
        uses: olympix/mutation-test-generator@main
        env:
          OLYMPIX_API_TOKEN: ${{ secrets.OLYMPIX_API_TOKEN }}
          GITHUB_REPOSITORY_ID: ${{ github.repository_id }}
          OLYMPIX_GITHUB_COMMIT_HEAD_SHA: ${{ github.sha }}
          OPIX_DEBUG: true
        with:
          args: ${{ steps.file-args.outputs.MUTATION_ARGS }}

      - name: Success Summary
        run: |
          # Configuration: Show excluded directories
          echo "üö´ Excluded directories: ${EXCLUDED_DIRS}"
          
          # Build find command with exclusions (same logic as above)
          FIND_CMD="find src/ -name '*.sol' -type f"
          for dir in Interfaces Libraries Helpers Errors; do
            FIND_CMD="$FIND_CMD ! -path 'src/$dir/*'"
          done
          
          total_files=$(eval "$FIND_CMD" | head -100 | wc -l)
          all_files=$(find src/ -name "*.sol" -type f | wc -l)
          excluded_files=$(eval "$FIND_CMD" | wc -l)
          excluded_count=$((all_files - excluded_files))
          
          echo "‚úÖ Mutation testing completed successfully"
          echo "üìÅ Processed $total_files chain-facing files (excluded $excluded_count utility files)"
          echo "üîç Results uploaded to GitHub Code Scanning"
          echo "üìã Check the Security tab for mutation testing alerts" 